<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Expense Overview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>

  <body class="bg-gray-50 min-h-screen text-gray-800">
    <div class="flex min-h-screen">
      <!-- SIDEBAR -->
      <aside class="w-60 bg-white border-r px-6 pt-10 flex flex-col">
        <div class="flex flex-col items-center mb-8">
          <div
            class="w-14 h-14 bg-red-200 rounded-full flex items-center justify-center font-bold text-xl text-red-700"
          >
            U
          </div>
          <span class="font-semibold text-sm mt-3" id="sidebarName"
            >Username</span
          >
        </div>
        <nav class="flex-1 flex flex-col gap-1 font-medium text-sm">
          <a
            href="dashboard.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded mb-1"
          >
            <i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>
            Dashboard
          </a>
          <a
            href="income.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded mb-1"
          >
            <i data-lucide="wallet" class="w-4 h-4 mr-3"></i> Income
          </a>
          <a
            href="expense.html"
            class="flex items-center px-4 py-2 bg-red-100 rounded text-red-700 mb-1"
          >
            <i data-lucide="credit-card" class="w-4 h-4 mr-3"></i> Expense
          </a>
          <a
            href="recommendation.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="sparkles" class="w-4 h-4 mr-3"></i> recommendation
          </a>
          <a
            href="installment.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="layers" class="w-4 h-4 mr-3"></i> Cicilan
          </a>
          <button
            onclick="logout()"
            class="flex items-center px-4 py-2 hover:bg-red-100 rounded text-red-600 mt-5"
          >
            <i data-lucide="log-out" class="w-4 h-4 mr-3"></i> Logout
          </button>
        </nav>
      </aside>

      <!-- MAIN -->
      <main class="flex-1 px-8 py-10">
        <!-- OVERVIEW -->
        <div class="bg-white rounded-lg shadow p-6 mb-7">
          <div
            class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4"
          >
            <div>
              <div class="font-bold text-xl">Expense Overview</div>
              <div class="text-gray-500 text-sm">
                Track your expenses over time and analyze spending trends.
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="flex items-center gap-2 text-sm">
                <label class="text-xs text-gray-500">From</label>
                <input
                  id="filterStart"
                  type="date"
                  class="rounded border-gray-200 px-2 py-1 text-sm"
                />
                <label class="text-xs text-gray-500">To</label>
                <input
                  id="filterEnd"
                  type="date"
                  class="rounded border-gray-200 px-2 py-1 text-sm"
                />
                <button
                  id="applyFilter"
                  class="bg-red-600 text-white px-3 py-1 rounded text-sm font-medium hover:bg-red-800"
                >
                  Apply
                </button>
              </div>
              <div class="flex gap-2">
                <button
                  id="openAddExpense"
                  class="bg-red-100 hover:bg-red-200 px-4 py-2 rounded font-semibold text-red-700 transition flex items-center"
                >
                  <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Expense
                </button>
              </div>
            </div>
          </div>
          <canvas id="expenseBarChart" height="100"></canvas>
        </div>

        <!-- SOURCES -->
        <div class="bg-white rounded-lg shadow px-6 pt-6 pb-6">
          <div class="flex justify-between items-center mb-4">
            <span class="font-semibold text-lg">Expense Sources</span>
            <div class="flex items-center gap-3">
              <button
                id="downloadCsv"
                class="flex items-center gap-2 bg-gray-100 px-3 py-1 rounded text-gray-700 font-medium"
              >
                <i data-lucide="download" class="w-4 h-4 text-red-600"></i>
                Download
              </button>
            </div>
          </div>
          <div
            id="expenseSources"
            class="grid grid-cols-1 md:grid-cols-2 gap-6 max-h-80 overflow-y-auto"
          ></div>
        </div>
      </main>
    </div>

    <!-- ADD EXPENSE MODAL -->
    <div
      id="expenseModal"
      class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white rounded-lg w-full max-w-md p-6 shadow-lg">
        <div class="flex justify-between items-center mb-4">
          <h2 class="font-bold text-lg">Tambah Expense</h2>
          <button
            id="closeExpenseModal"
            class="text-gray-400 hover:text-gray-700 text-xl"
          >
            &times;
          </button>
        </div>
        <form id="expenseForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Nominal</label>
            <input
              id="expenseAmount"
              type="number"
              required
              class="w-full rounded border-gray-200 px-3 py-2 focus:ring focus:ring-red-100"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Kategori</label>
            <input
              id="expenseCategory"
              type="text"
              class="w-full rounded border-gray-200 px-3 py-2 focus:ring focus:ring-red-100"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Tanggal</label>
            <input
              id="expenseDate"
              type="date"
              required
              class="w-full rounded border-gray-200 px-3 py-2 focus:ring focus:ring-red-100"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1"
              >Cicilan (opsional)</label
            >
            <select
              id="expenseInstallment"
              class="w-full rounded border-gray-200 px-3 py-2 focus:ring focus:ring-red-100"
            >
              <option value="">Bukan pembayaran cicilan</option>
            </select>
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-red-600 text-white font-bold px-5 py-2 rounded hover:bg-red-800"
            >
              Tambah
            </button>
          </div>
        </form>
        <div id="expenseModalMsg" class="mt-3 text-center text-sm"></div>
      </div>
    </div>

    <!-- ADD INSTALLMENT MODAL -->
    <div
      id="installmentModal"
      class="fixed inset-0 hidden bg-gray-700 bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 flex items-center">
          <i data-lucide="layers" class="w-5 h-5 mr-2"></i> Tambah Cicilan
        </h2>

        <form id="installmentForm" class="space-y-3">
          <div>
            <label class="block font-medium text-sm">Nama Cicilan</label>
            <input
              type="text"
              name="name"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm"
              >Jumlah Pokok (principal)</label
            >
            <input
              type="number"
              name="principal"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm">Bunga (%)</label>
            <input
              type="number"
              name="interest_rate"
              class="w-full border p-2 rounded"
              value="0"
            />
          </div>
          <div>
            <label class="block font-medium text-sm">Cicilan per Bulan</label>
            <input
              type="number"
              name="monthly_payment"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm"
              >Lama Cicilan (bulan)</label
            >
            <input
              type="number"
              name="total_months"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm">Tanggal Mulai</label>
            <input
              type="date"
              name="start_date"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm"
              >Jatuh Tempo Hari Ke-</label
            >
            <input
              type="number"
              name="due_day"
              class="w-full border p-2 rounded"
              required
            />
          </div>
          <div>
            <label class="block font-medium text-sm">Catatan</label>
            <textarea name="notes" class="w-full border p-2 rounded"></textarea>
          </div>

          <div id="installmentModalMsg" class="text-sm text-center"></div>

          <div class="flex justify-end space-x-2 pt-2">
            <button
              type="button"
              id="closeInstallmentModal"
              class="bg-gray-200 px-3 py-1 rounded"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="bg-purple-600 text-white px-4 py-1 rounded"
            >
              Simpan
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function formatRupiah(num) {
        if (num === null || num === undefined || isNaN(num)) return "Rp 0";
        return "Rp " + Number(num).toLocaleString("id-ID");
      }
      function logout() {
        localStorage.removeItem("jwt");
        location.href = "/login.html";
      }

      const jwt = localStorage.getItem("jwt");
      if (!jwt) logout();

      fetch("/api/expense/profile", {
        headers: { Authorization: "Bearer " + jwt },
      })
        .then((r) => r.json())
        .then((data) => {
          document.getElementById("sidebarName").textContent =
            data.userName || "User";
          document.querySelector(".w-14.h-14").textContent = getInitials(
            data.userName
          );
        });

      function getInitials(name) {
        if (!name) return "U";
        return name
          .split(" ")
          .map((part) => part[0])
          .join("")
          .toUpperCase()
          .slice(0, 2);
      }

      function kategoriLucide(cat) {
        const map = {
          makan: "pizza",
          belanja: "shopping-bag",
          transport: "bus",
          listrik: "bolt",
          travel: "plane",
          kesehatan: "heart-pulse",
          lainnya: "file-minus",
        };
        return map[cat?.toLowerCase()] || "credit-card";
      }

      function isoDate(d) {
        return d.toISOString().slice(0, 10);
      }
      const today = new Date();
      const last30 = new Date();
      last30.setDate(today.getDate() - 29);
      document.getElementById("filterStart").value = isoDate(last30);
      document.getElementById("filterEnd").value = isoDate(today);

      let expenseBarChart = null;

      async function fetchExpenseOverview(start, end) {
        const qs = `?start=${encodeURIComponent(
          start
        )}&end=${encodeURIComponent(end)}`;
        const res = await fetch("/api/expense/overview" + qs, {
          headers: { Authorization: "Bearer " + jwt },
        });
        if (!res.ok) return console.error("Failed fetching overview");
        const data = await res.json();
        const labels = (data.barChart || []).map((x) => x.date);
        const amounts = (data.barChart || []).map((x) => x.amount);
        const canvas = document.getElementById("expenseBarChart");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        if (expenseBarChart) expenseBarChart.destroy();
        expenseBarChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                data: amounts,
                backgroundColor: labels.map(
                  (_, i) =>
                    ["#fca5a5", "#fecaca", "#f87171", "#fee2e2", "#fbbf24"][
                      i % 5
                    ]
                ),
                maxBarThickness: 40,
              },
            ],
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } },
          },
        });
      }

      async function fetchExpenseSources(start, end) {
        const qs = `?start=${encodeURIComponent(
          start
        )}&end=${encodeURIComponent(end)}`;
        const res = await fetch("/api/expense/summary" + qs, {
          headers: { Authorization: "Bearer " + jwt },
        });
        if (!res.ok) return console.error("Failed fetching expense summary");
        const data = await res.json();
        const container = document.getElementById("expenseSources");
        container.innerHTML = "";
        const colA = document.createElement("div");
        const colB = document.createElement("div");
        (data.recent || []).forEach((src, i) => {
          const card = document.createElement("div");
          card.className =
            "flex items-center gap-3 bg-gray-50 rounded-lg px-4 py-3 mb-3";
          card.innerHTML = `
          <i data-lucide="${kategoriLucide(
            src.category
          )}" class="w-7 h-7 text-red-500"></i>
          <div class="flex-1">
            <div class="font-semibold text-sm">${src.category}</div>
            <div class="text-xs text-gray-400">${src.date}</div>
          </div>
          <div class="text-red-600 font-bold">-${formatRupiah(src.amount)}</div>
        `;
          if (i % 2 === 0) colA.appendChild(card);
          else colB.appendChild(card);
        });
        container.appendChild(colA);
        container.appendChild(colB);
        if (window.lucide && lucide.createIcons) lucide.createIcons();
      }

      let installmentList = [];

      async function loadInstallmentOptions() {
        try {
          const res = await fetch("/api/installments", {
            headers: { Authorization: "Bearer " + jwt },
          });
          if (!res.ok) return;
          const list = await res.json();

          installmentList = list;

          const sel = document.getElementById("expenseInstallment");
          sel.innerHTML =
            '<option value="">Bukan pembayaran cicilan</option>' +
            list
              .filter((i) => i.status === "active")
              .map((i) => `<option value="${i.id}">${i.name}</option>`)
              .join("");
        } catch (e) {
          console.error(e);
        }
      }

      async function loadAll() {
        const start = document.getElementById("filterStart").value;
        const end = document.getElementById("filterEnd").value;
        await fetchExpenseOverview(start, end);
        await fetchExpenseSources(start, end);
        if (window.lucide && lucide.createIcons) lucide.createIcons();
      }

      document
        .getElementById("applyFilter")
        .addEventListener("click", () => loadAll());

      document
        .getElementById("openAddExpense")
        .addEventListener("click", () => {
          document.getElementById("expenseModal").classList.remove("hidden");
          document.getElementById("expenseModalMsg").textContent = "";
        });
      document
        .getElementById("closeExpenseModal")
        .addEventListener("click", () => {
          document.getElementById("expenseModal").classList.add("hidden");
        });

      // Submit ADD expense (otomatis bedakan biasa vs cicilan)
      document
        .getElementById("expenseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const amount = Number(document.getElementById("expenseAmount").value);
          let category = document
            .getElementById("expenseCategory")
            .value.trim();
          const date = document.getElementById("expenseDate").value;
          const installment_id_raw =
            document.getElementById("expenseInstallment").value;
          const installment_id = installment_id_raw || null;
          const msgDiv = document.getElementById("expenseModalMsg");

          msgDiv.textContent = "";
          msgDiv.className = "mt-3 text-center text-sm";

          if (!amount || !date) {
            msgDiv.textContent = "Nominal dan tanggal wajib diisi.";
            msgDiv.classList.add("text-red-600");
            return;
          }

          if (installment_id) {
            category = "cicilan";
          } else if (!category) {
            msgDiv.textContent =
              "Kategori wajib diisi untuk pengeluaran biasa.";
            msgDiv.classList.add("text-red-600");
            return;
          }

          try {
            const res = await fetch("/api/expense", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + jwt,
              },
              body: JSON.stringify({ amount, category, date, installment_id }),
            });
            const result = await res.json();

            if (res.ok) {
              msgDiv.textContent = installment_id
                ? "Pembayaran cicilan berhasil dicatat!"
                : "Expense berhasil ditambahkan!";
              msgDiv.classList.add("text-green-600");

              e.target.reset();
              document.getElementById("expenseInstallment").value = "";

              setTimeout(() => {
                document.getElementById("expenseModal").classList.add("hidden");
                loadAll();
              }, 700);
            } else {
              msgDiv.textContent = result.error || "Gagal menyimpan expense.";
              msgDiv.classList.add("text-red-600");
            }
          } catch (err) {
            console.error(err);
            msgDiv.textContent = "Gagal koneksi ke server";
            msgDiv.classList.add("text-red-600");
          }
        });

      // AUTO-FILL NOMINAL SAAT PILIH CICILAN
      document
        .getElementById("expenseInstallment")
        .addEventListener("change", (e) => {
          const selectedId = Number(e.target.value);
          const amountInput = document.getElementById("expenseAmount");
          if (!selectedId) return;
          const inst = installmentList.find((i) => i.id === selectedId);
          if (!inst) return;
          amountInput.value = inst.monthly_payment || 0;
        });

      // SUBMIT TAMBAH CICILAN
      document
        .getElementById("installmentForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formEl = e.target;
          const formData = Object.fromEntries(new FormData(formEl).entries());

          const name = formData.name?.trim();
          const principal = Number(formData.principal);
          const interest_rate = Number(formData.interest_rate || 0);
          const monthly_payment = Number(formData.monthly_payment);
          const total_months = Number(formData.total_months);
          const start_date = formData.start_date;
          const due_day = Number(formData.due_day);
          const notes = formData.notes || null;

          const msg = document.getElementById("installmentModalMsg");
          msg.textContent = "";
          msg.className = "text-sm text-center";

          if (
            !name ||
            !principal ||
            !monthly_payment ||
            !total_months ||
            !start_date ||
            !due_day
          ) {
            msg.textContent =
              "Semua field wajib diisi dan harus angka yang valid.";
            msg.className += " text-red-600";
            return;
          }

          try {
            const res = await fetch("/api/installments", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + jwt,
              },
              body: JSON.stringify({
                name,
                principal,
                interest_rate,
                monthly_payment,
                total_months,
                start_date,
                due_day,
                notes,
              }),
            });

            const result = await res.json();

            if (!res.ok) {
              msg.textContent = result.error || "Gagal menambah cicilan";
              msg.className += " text-red-600";
              return;
            }

            msg.textContent = "Cicilan berhasil ditambahkan!";
            msg.className += " text-green-600";

            await loadInstallmentOptions();

            setTimeout(() => {
              formEl.reset();
              document
                .getElementById("installmentModal")
                .classList.add("hidden");
            }, 700);
          } catch (err) {
            console.error(err);
            msg.textContent = "Gagal koneksi ke server";
            msg.className += " text-red-600";
          }
        });

      // Inisialisasi + handle datang dari dashboard
      window.addEventListener("DOMContentLoaded", async () => {
        await loadInstallmentOptions();
        await loadAll();
        if (window.lucide && lucide.createIcons) lucide.createIcons();

        const instIdFromDash = getQueryParam("installment_id");
        if (instIdFromDash) {
          const sel = document.getElementById("expenseInstallment");
          sel.value = instIdFromDash;
          document.getElementById("expenseModal").classList.remove("hidden");
          sel.dispatchEvent(new Event("change"));
        }
      });
    </script>
  </body>
</html>
