<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekomendasi Produk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>

  <body class="bg-gray-100 min-h-screen text-gray-800">
    <div class="flex min-h-screen">
      <!-- SIDEBAR SINGKAT -->
      <aside class="w-60 bg-white border-r px-6 pt-10 flex flex-col">
        <div class="flex flex-col items-center mb-8">
          <div
            id="avatarInitial"
            class="w-14 h-14 bg-purple-200 rounded-full flex items-center justify-center font-bold text-xl text-purple-700"
          >
            U
          </div>
          <span class="font-semibold mt-3 text-sm" id="sidebarName"
            >Username</span
          >
        </div>

        <nav class="flex-1 flex flex-col gap-1 font-medium text-sm">
          <a
            href="dashboard.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i>
            Dashboard
          </a>
          <a
            href="income.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="wallet" class="w-4 h-4 mr-3"></i> Income
          </a>
          <a
            href="expense.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="credit-card" class="w-4 h-4 mr-3"></i> Expense
          </a>
          <a
            href="recommendation.html"
            class="flex items-center px-4 py-2 bg-purple-100 rounded text-purple-700"
          >
            <i data-lucide="sparkles" class="w-4 h-4 mr-3"></i> Recommendation
          </a>
          <a
            href="installment.html"
            class="flex items-center px-4 py-2 hover:bg-gray-100 rounded"
          >
            <i data-lucide="layers" class="w-4 h-4 mr-3"></i> Cicilan
          </a>
          <button
            onclick="logout()"
            class="flex items-center px-4 py-2 hover:bg-red-100 rounded text-red-600 mt-5"
          >
            <i data-lucide="log-out" class="w-4 h-4 mr-3"></i> Logout
          </button>
        </nav>
      </aside>

      <!-- MAIN -->
      <main class="flex-1 px-8 py-8">
        <div
          class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <h1 class="text-xl font-bold">Rekomendasi Produk</h1>
            <p class="text-sm text-gray-500">
              Produk yang harganya di bawah saldo terakhir kamu.
            </p>
            <p class="mt-2 text-sm">
              Saldo kamu:
              <span id="balanceText" class="font-semibold text-green-700"
                >Rp 0</span
              >
            </p>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-sm text-gray-600">Kategori</label>
            <select
              id="categorySelect"
              class="border rounded px-3 py-1 text-sm"
            >
              <option value="all">Semua</option>
              <option value="fashion">Pakaian / Fashion</option>
              <option value="electronics">Elektronik</option>
              <option value="furniture">Furniture</option>
            </select>
            <button
              id="applyBtn"
              class="bg-purple-600 text-white px-4 py-1.5 rounded text-sm hover:bg-purple-800"
            >
              Terapkan
            </button>
          </div>
        </div>

        <div id="infoText" class="text-xs text-gray-500 mb-3"></div>

        <div
          id="recommendationList"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        ></div>
      </main>
    </div>

    <script>
      function formatRupiah(num) {
        if (!num || isNaN(num)) return "Rp 0";
        return "Rp " + Number(num).toLocaleString("id-ID");
      }

      function logout() {
        localStorage.removeItem("jwt");
        location.href = "/login.html";
      }

      const jwt = localStorage.getItem("jwt");
      if (!jwt) logout();

      async function loadProfile() {
        // pakai /api/dashboard hanya untuk ambil nama (bisa juga pakai /api/income/profile)
        const res = await fetch("/api/dashboard", {
          headers: { Authorization: "Bearer " + jwt },
        });
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById("sidebarName").textContent =
          data.userName || "User";
        document.getElementById("avatarInitial").textContent = (
          data.userName || "U"
        )
          .split(" ")
          .map((p) => p[0])
          .join("")
          .toUpperCase()
          .slice(0, 2);
      }

      async function loadRecommendations() {
        const category = document.getElementById("categorySelect").value; // all/fashion/electronics/furniture
        const res = await fetch(
          "/api/recommendations?category=" + encodeURIComponent(category),
          {
            headers: { Authorization: "Bearer " + jwt },
          }
        );
        if (!res.ok) {
          document.getElementById("infoText").textContent =
            "Gagal mengambil rekomendasi dari server.";
          return;
        }
        const data = await res.json();
        document.getElementById("balanceText").textContent = formatRupiah(
          data.balance || 0
        );
        document.getElementById(
          "infoText"
        ).textContent = `Menampilkan kategori: ${category} — hanya produk dengan harga ≤ saldo kamu.`;

        renderRecommendations(data.recommendations || []);
        if (window.lucide && lucide.createIcons) lucide.createIcons();
      }

      function renderRecommendations(list) {
        const container = document.getElementById("recommendationList");
        if (!list || list.length === 0) {
          container.innerHTML =
            '<div class="text-gray-400 text-sm">Tidak ada produk yang cocok dengan saldo dan kategori ini.</div>';
          return;
        }
        container.innerHTML = list
          .map(
            (item) => `
        <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition flex flex-col justify-between">
          <div>
            <div class="font-semibold text-sm leading-tight mb-1">${
              item.name
            }</div>
            <div class="text-xs text-gray-500 mb-2">${item.category}</div>
            <div class="text-green-600 font-bold text-sm mb-1">${formatRupiah(
              item.priceIdr
            )}</div>
            <div class="text-xs text-gray-500">
              <span class="text-yellow-500 font-medium">⭐ ${
                item.rating || "-"
              }</span>
            </div>
          </div>
          <div class="mt-3 flex justify-between items-center">
            <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded">
              score: ${item.finalScore}
            </span>
           
          </div>
        </div>
      `
          )
          .join("");
      }

      //  <button class="text-xs px-2 py-1 border rounded text-purple-700 border-purple-300 hover:bg-purple-50">
      //       Simpan Ide
      //     </button>

      document
        .getElementById("applyBtn")
        .addEventListener("click", loadRecommendations);

      loadProfile();
      loadRecommendations();
      if (window.lucide && lucide.createIcons) lucide.createIcons();
    </script>
  </body>
</html>
