<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expense Tracker - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-gray-100 min-h-screen text-gray-800">
  <div class="flex min-h-screen">
    <!-- SIDEBAR -->
    <aside class="w-60 bg-white border-r px-6 pt-10 flex flex-col">
      <div class="flex flex-col items-center mb-8">
        <div id="avatarInitial"
          class="w-14 h-14 bg-purple-200 rounded-full flex items-center justify-center font-bold text-xl text-purple-700">
          U
        </div>
        <span class="font-semibold mt-3 text-sm" id="sidebarName">Username</span>
      </div>
      <nav class="flex-1 flex flex-col gap-1 font-medium text-sm">
        <a href="dashboard.html" class="flex items-center px-4 py-2 bg-purple-100 rounded text-purple-700">
          <i data-lucide="layout-dashboard" class="w-4 h-4 mr-3"></i> Dashboard
        </a>
        <a href="income.html" class="flex items-center px-4 py-2 hover:bg-gray-100 rounded">
          <i data-lucide="wallet" class="w-4 h-4 mr-3"></i> Income
        </a>
        <a href="expense.html" class="flex items-center px-4 py-2 hover:bg-gray-100 rounded">
          <i data-lucide="credit-card" class="w-4 h-4 mr-3"></i> Expense
        </a>
        <a href="recommendation.html" class="flex items-center px-4 py-2 hover:bg-gray-100 rounded">
          <i data-lucide="sparkles" class="w-4 h-4 mr-3"></i> Recommendation
        </a>
        <a href="installment.html" class="flex items-center px-4 py-2 hover:bg-gray-100 rounded">
          <i data-lucide="layers" class="w-4 h-4 mr-3"></i> Cicilan
        </a>
        <button onclick="logout()" class="flex items-center px-4 py-2 hover:bg-red-100 rounded text-red-600 mt-5">
          <i data-lucide="log-out" class="w-4 h-4 mr-3"></i> Logout
        </button>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 px-8 py-8">
      <!-- SUMMARY CARDS -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow px-5 py-5 flex items-center justify-between">
          <div>
            <div class="text-gray-500 text-xs font-medium">Total Balance</div>
            <div class="text-2xl font-bold text-purple-600" id="totalBalance">Rp 0</div>
          </div>
          <i data-lucide="piggy-bank" class="w-7 h-7 text-purple-500"></i>
        </div>
        <div class="bg-white rounded-lg shadow px-5 py-5 flex items-center justify-between">
          <div>
            <div class="text-gray-500 text-xs font-medium">Total Income</div>
            <div class="text-xl font-bold text-orange-600" id="totalIncome">Rp 0</div>
          </div>
          <i data-lucide="arrow-down-circle" class="w-7 h-7 text-orange-500"></i>
        </div>
        <div class="bg-white rounded-lg shadow px-5 py-5 flex items-center justify-between">
          <div>
            <div class="text-gray-500 text-xs font-medium">Total Expense</div>
            <div class="text-xl font-bold text-red-600" id="totalExpense">Rp 0</div>
          </div>
          <i data-lucide="arrow-up-circle" class="w-7 h-7 text-red-500"></i>
        </div>
      </div>

      <!-- 2 COLUMN GRID -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- LEFT COLUMN -->
        <div class="space-y-6">
          <!-- RECENT TRANSACTIONS -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4 text-sm font-semibold">
              <span>Recent Transactions</span>
              <a href="expense.html" class="px-3 py-1 bg-purple-100 rounded hover:bg-purple-200">See All</a>
            </div>
            <ul id="transactionsList" class="space-y-4 text-sm"></ul>
          </div>

          <!-- FINANCIAL OVERVIEW / DONUT -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="font-semibold text-sm mb-3">Financial Overview</div>
            <canvas id="overviewChart" height="160"></canvas>
          </div>

          <!-- INSTALLMENT OVERVIEW CARD -->

        </div>

        <!-- RIGHT COLUMN -->
        <div class="space-y-6">
          <!-- INSTALLMENT OVERVIEW CARD -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-3">
              <div>
                <div class="font-semibold text-sm">Installment Overview</div>
                <div class="text-xs text-gray-500">Ringkasan cicilan bulan ini.</div>
              </div>
              <a href="installment.html"
                class="text-xs px-3 py-1 rounded bg-purple-100 text-purple-700 hover:bg-purple-200">
                Kelola Cicilan
              </a>
            </div>
            <div id="billsSummary" class="text-xs text-gray-600">
              <!-- diisi JS -->
            </div>
          </div>

          <!-- UPCOMING INSTALLMENTS (H-10 s/d H) -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-3">
              <div>
                <div class="font-semibold text-sm">Cicilan Menjelang Jatuh Tempo</div>
                <div class="text-xs text-gray-500">
                  Daftar cicilan H-10 sampai hari ini.
                </div>
              </div>
              <a href="installment.html"
                class="text-xs px-3 py-1 rounded bg-yellow-100 text-yellow-700 hover:bg-yellow-200">
                Lihat Semua
              </a>
            </div>
            <div id="upcomingInstallments" class="space-y-3 text-xs">
              <!-- diisi JS -->
            </div>
          </div>

          <!-- RECENT EXPENSES -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4 text-sm font-semibold">
              <span>Recent Expenses</span>
              <a href="expense.html" class="px-3 py-1 bg-red-100 rounded text-red-700 hover:bg-red-200">See All</a>
            </div>
            <ul id="expensesList" class="space-y-4 text-sm"></ul>
          </div>

          <!-- RECENT INCOME -->
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-4 text-sm font-semibold">
              <span>Recent Income</span>
              <a href="income.html" class="px-3 py-1 bg-green-100 rounded text-green-700 hover:bg-green-200">See All</a>
            </div>
            <ul id="incomeList" class="space-y-4 text-sm"></ul>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    async function payInstallment(id) {
      if (!confirm("Bayar cicilan bulan ini?")) return;

      try {
        const res = await fetch(`/api/expense/pay-installment/${id}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + jwt
          }
        });

        const data = await res.json();

        if (res.ok) {
          alert("Cicilan berhasil dicatat sebagai expense.");
          loadUpcomingInstallments();
          fetchExpenseStats();
          fetchIncomeStats();
        } else {
          alert(data.error || "Gagal membayar cicilan.");
        }
      } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan.");
      }
    }

    async function loadBillsSummary() {
      try {
        const res = await fetch('/api/bills/recommendations', {
          headers: { Authorization: 'Bearer ' + jwt }
        });
        if (!res.ok) {
          document.getElementById('billsSummary').textContent =
            'Gagal memuat info cicilan bulan ini.';
          return;
        }
        const data = await res.json();

        const el = document.getElementById('billsSummary');
        const totalMin = Number(data.totalMinimum || 0);
        const sisa = Number(data.balanceAfterMinimum || 0);

        let statusText = data.message || '';
        if (data.status === 'warning') {
          el.classList.remove('text-gray-600');
          el.classList.add('text-red-600');
        } else {
          el.classList.remove('text-red-600');
          el.classList.add('text-gray-600');
        }

        el.innerHTML = `
          Total cicilan minimum bulan ini:
          <span class="font-semibold">${formatRupiah(totalMin)}</span><br>
          Sisa saldo setelah bayar cicilan:
          <span class="font-semibold">${formatRupiah(sisa)}</span><br>
          <span class="text-xs">${statusText}</span>
        `;
      } catch (e) {
        console.error(e);
        document.getElementById('billsSummary').textContent =
          'Gagal memuat info cicilan bulan ini.';
      }
    }
    async function loadUpcomingInstallments() {
      try {
        const res = await fetch('/api/installments/upcoming', {
          headers: { Authorization: 'Bearer ' + jwt }
        });
        const container = document.getElementById('upcomingInstallments');

        if (!res.ok) {
          container.innerHTML =
            '<div class="text-gray-400">Gagal memuat cicilan menjelang jatuh tempo.</div>';
          return;
        }

        const list = await res.json();
        if (!list || list.length === 0) {
          container.innerHTML =
            '<div class="text-gray-400">Tidak ada cicilan H-10 sampai hari ini.</div>';
          return;
        }

        container.innerHTML = list.map(item => `
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="font-semibold text-xs">${item.name}</div>
          <div class="text-[11px] text-gray-500">
            Jatuh tempo tanggal ${item.due_day} Â·
            Sisa ${item.remaining_months} bulan
          </div>
          <div class="text-[11px] text-gray-500">
            Bayar per bulan:
            <span class="font-semibold text-green-700">
              ${formatRupiah(item.monthly_payment)}
            </span>
          </div>
        </div>

        <button 
           onclick="location.href = 'expense.html?installment_id=${item.id}'"
          class="text-[10px] px-2 py-1 rounded bg-purple-100 text-purple-700 hover:bg-purple-200">
          Bayar
        </button>
      </div>
    `).join('');

      } catch (e) {
        console.error(e);
        document.getElementById('upcomingInstallments').innerHTML =
          '<div class="text-gray-400">Gagal memuat cicilan menjelang jatuh tempo.</div>';
      }
    }


    function formatRupiah(num) {
      if (!num || isNaN(num)) return 'Rp 0';
      return 'Rp ' + Number(num).toLocaleString('id-ID');
    }

    function logout() {
      localStorage.removeItem('jwt');
      location.href = '/login.html';
    }

    const jwt = localStorage.getItem('jwt');
    if (!jwt) logout();

    let overviewChart;

    function getInitials(name) {
      if (!name) return 'U';
      return name.split(' ').map(part => part[0]).join('').toUpperCase().slice(0, 2);
    }

    // DASHBOARD DATA
    fetch('/api/dashboard', { headers: { Authorization: 'Bearer ' + jwt } })
      .then(r => r.json())
      .then(data => {
        console.log('dashboard data:', data);

        document.getElementById('sidebarName').textContent = data.userName || 'User';
        document.getElementById('avatarInitial').textContent = getInitials(data.userName || 'User');
        document.getElementById('totalBalance').textContent =
          formatRupiah((data.totalIncome || 0) - (data.totalExpense || 0));
        document.getElementById('totalIncome').textContent =
          formatRupiah(data.totalIncome || 0);
        document.getElementById('totalExpense').textContent =
          formatRupiah(data.totalExpense || 0);

        const latest = Array.isArray(data.latest) ? data.latest : [];
        document.getElementById('transactionsList').innerHTML = latest.map(trx => `
          <li class="flex items-center justify-between">
            <i data-lucide="${trx.type === 'income' ? 'wallet' : 'credit-card'}"
               class="w-4 h-4 mr-3 ${trx.type === 'income' ? 'text-green-600' : 'text-red-600'}"></i>
            <div class="flex-1">
              <div class="font-medium text-sm">${trx.category}</div>
              <div class="text-xs text-gray-400">${trx.date}</div>
            </div>
            <span class="font-bold ${trx.type === 'income' ? 'text-green-600' : 'text-red-600'}">
              ${trx.type === 'income' ? '+' : '-'}${formatRupiah(trx.amount)}
            </span>
          </li>
        `).join('');

        const ctxO = document.getElementById('overviewChart').getContext('2d');
        if (overviewChart) overviewChart.destroy();
        overviewChart = new Chart(ctxO, {
          type: 'doughnut',
          data: {
            labels: ['Balance', 'Expense', 'Income'],
            datasets: [{
              data: [
                (data.totalIncome || 0) - (data.totalExpense || 0),
                data.totalExpense || 0,
                data.totalIncome || 0
              ],
              backgroundColor: ['#805ad5', '#f56565', '#ed8936']
            }]
          },
          options: { plugins: { legend: { position: 'bottom' } } }
        });

        if (window.lucide && lucide.createIcons) lucide.createIcons();
      });

    // EXPENSE STATS
    async function fetchExpenseStats() {
      const res = await fetch('/api/expense/summary', {
        headers: { Authorization: 'Bearer ' + jwt }
      });
      const data = await res.json();
      document.getElementById('expensesList').innerHTML = (data.recent || []).map(exp => `
        <li class="flex items-center justify-between">
          <i data-lucide="credit-card" class="w-4 h-4 mr-3 text-red-500"></i>
          <div class="flex-1">
            <div class="font-medium text-sm">${exp.category}</div>
            <div class="text-xs text-gray-400">${exp.date}</div>
          </div>
          <span class="text-red-600 font-bold">-${formatRupiah(exp.amount)}</span>
        </li>
      `).join('');
      if (window.lucide && lucide.createIcons) lucide.createIcons();
    }

    // INCOME STATS
    async function fetchIncomeStats() {
      const res = await fetch('/api/income/summary', {
        headers: { Authorization: 'Bearer ' + jwt }
      });
      const data = await res.json();
      document.getElementById('incomeList').innerHTML = (data.recent || []).map(inc => `
        <li class="flex items-center justify-between">
          <i data-lucide="wallet" class="w-4 h-4 mr-3 text-green-500"></i>
          <div class="flex-1">
            <div class="font-medium text-sm">${inc.category}</div>
            <div class="text-xs text-gray-400">${inc.date}</div>
          </div>
          <span class="text-green-600 font-bold">+${formatRupiah(inc.amount)}</span>
        </li>
      `).join('');
      if (window.lucide && lucide.createIcons) lucide.createIcons();
    }

    fetchExpenseStats();
    fetchIncomeStats();
    loadBillsSummary();
    loadUpcomingInstallments();

  </script>
</body>

</html>